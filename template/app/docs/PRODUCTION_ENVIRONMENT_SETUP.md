# Production Environment Setup Guide

This guide covers all environment variables and configuration needed for production deployment of Postmarkr.

## ðŸ”‘ **Required Environment Variables**

### **Core Application**
```bash
# Database
DATABASE_URL="postgresql://username:password@host:port/database"

# JWT Secret (auto-generated by Wasp)
JWT_SECRET="your-jwt-secret-here"

# Application URLs
WASP_WEB_CLIENT_URL="https://your-domain.com"
WASP_SERVER_URL="https://your-api-domain.com"
```

### **Email Service (SendGrid)**
```bash
# SendGrid Configuration
SENDGRID_API_KEY="SG.your_sendgrid_api_key_here"
SENDGRID_FROM_EMAIL="info@postmarkr.com"
SENDGRID_FROM_NAME="Postmarkr"
```

### **Payment Processing (Stripe)**
```bash
# Stripe Configuration
STRIPE_SECRET_KEY="sk_live_your_stripe_secret_key_here"
STRIPE_PUBLISHABLE_KEY="pk_live_your_stripe_publishable_key_here"
STRIPE_WEBHOOK_SECRET="whsec_your_stripe_webhook_secret_here"
```

### **Mail Service (Lob)**
```bash
# Lob API Configuration
LOB_PROD_KEY="live_your_lob_production_api_key_here"
LOB_ENVIRONMENT="live"
LOB_WEBHOOK_SECRET="your_lob_webhook_secret_here"
```

### **File Storage (AWS S3)**
```bash
# AWS S3 Configuration
AWS_S3_REGION="us-east-1"
AWS_S3_IAM_ACCESS_KEY="your_aws_access_key_id"
AWS_S3_IAM_SECRET_KEY="your_aws_secret_access_key"
AWS_S3_FILES_BUCKET="your-s3-bucket-name"
```

### **Monitoring & Analytics**
```bash
# Sentry Error Tracking
SENTRY_DSN="https://your-sentry-dsn@sentry.io/project-id"
SENTRY_RELEASE="v1.0.0"
SENTRY_SERVER_NAME="postmarkr-production"

# Optional: Google Analytics
GOOGLE_ANALYTICS_ID="G-XXXXXXXXXX"
```

## ðŸš€ **Production Deployment Steps**

### **1. Environment Variables Setup**

Create a `.env.server` file with all required variables:

```bash
# Copy this template and fill in your values
cp .env.example .env.server
```

### **2. Database Migration**

```bash
# Run database migrations
wasp db migrate-dev "Production migration"
# Or for production deployment
wasp db migrate-prod
```

### **3. Email Provider Configuration**

The application is configured to use SendGrid. Ensure your SendGrid account is set up:

1. **Create SendGrid Account**: Sign up at [sendgrid.com](https://sendgrid.com)
2. **Get API Key**: Create a new API key with "Full Access" permissions
3. **Domain Authentication** (Recommended):
   - Go to Settings â†’ Sender Authentication
   - Add your domain (e.g., `postmarkr.com`)
   - Add the required DNS records
4. **Update main.wasp**: Already configured to use SendGrid

### **4. Lob API Setup**

1. **Create Lob Account**: Sign up at [lob.com](https://lob.com)
2. **Get Production API Key**: 
   - Go to Settings â†’ API Keys
   - Copy your Live API Key (starts with `live_`)
3. **Set Up Webhooks**:
   - Go to Settings â†’ Webhooks
   - Add webhook URL: `https://your-api-domain.com/webhooks/lob`
   - Select events: `postcard.created`, `postcard.updated`, `letter.created`, `letter.updated`
   - Copy the webhook secret

### **5. Stripe Configuration**

1. **Create Stripe Account**: Sign up at [stripe.com](https://stripe.com)
2. **Get API Keys**:
   - Go to Developers â†’ API Keys
   - Copy Secret Key and Publishable Key
3. **Set Up Webhooks**:
   - Go to Developers â†’ Webhooks
   - Add endpoint: `https://your-api-domain.com/payments-webhook`
   - Select events: `payment_intent.succeeded`, `payment_intent.payment_failed`
   - Copy the webhook secret

### **6. AWS S3 Setup**

1. **Create AWS Account**: Sign up at [aws.amazon.com](https://aws.amazon.com)
2. **Create S3 Bucket**:
   - Go to S3 service
   - Create bucket with unique name
   - Configure CORS policy for file uploads
3. **Create IAM User**:
   - Go to IAM service
   - Create user with S3 permissions
   - Generate access keys

### **7. Sentry Setup**

1. **Create Sentry Account**: Sign up at [sentry.io](https://sentry.io)
2. **Create Project**:
   - Create new project for Node.js
   - Copy the DSN
3. **Configure Alerts**:
   - Set up alert rules for errors
   - Configure notification channels

## ðŸ”’ **Security Considerations**

### **Environment Variable Security**
- Never commit `.env.server` to version control
- Use strong, unique secrets for all services
- Rotate API keys regularly
- Use different keys for development and production

### **Webhook Security**
- Always verify webhook signatures
- Use HTTPS for all webhook endpoints
- Implement rate limiting on webhook endpoints
- Monitor for suspicious webhook activity

### **Database Security**
- Use strong database passwords
- Enable SSL connections
- Restrict database access by IP
- Regular security updates

## ðŸ“Š **Monitoring Setup**

### **Health Checks**
- Basic health check: `GET /health`
- Detailed health check: `GET /health/detailed`
- Monitor these endpoints with your monitoring service

### **Sentry Alerts**
Configure alerts for:
- Error rate > 5% in 5 minutes
- New error types
- Performance degradation
- Webhook failures

### **Log Monitoring**
Monitor logs for:
- Authentication failures
- Payment processing errors
- Mail service errors
- Database connection issues

## ðŸ§ª **Testing Production Setup**

### **1. Health Check Test**
```bash
curl https://your-api-domain.com/health
```

Expected response:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "services": {
    "database": "ok",
    "environment": "ok",
    "lob": "ok",
    "stripe": "ok",
    "sendgrid": "ok"
  },
  "uptime": 3600,
  "version": "1.0.0"
}
```

### **2. Email Test**
- Create a test user account
- Trigger email verification
- Check SendGrid dashboard for delivery

### **3. Payment Test**
- Create a test mail piece
- Process payment with Stripe test mode
- Verify webhook receives payment events

### **4. Mail Service Test**
- Create a test mail piece
- Submit to Lob API
- Verify webhook receives status updates

## ðŸš¨ **Troubleshooting**

### **Common Issues**

1. **Email Not Sending**
   - Check SendGrid API key
   - Verify domain authentication
   - Check SendGrid dashboard for errors

2. **Webhook Not Working**
   - Verify webhook URL is accessible
   - Check webhook secret configuration
   - Review webhook logs in service dashboards

3. **Database Connection Issues**
   - Verify DATABASE_URL format
   - Check database server status
   - Review connection limits

4. **Payment Processing Errors**
   - Verify Stripe API keys
   - Check webhook configuration
   - Review Stripe dashboard for errors

### **Debug Mode**
Enable debug logging by setting:
```bash
NODE_ENV=development
DEBUG=*
```

## ðŸ“ˆ **Performance Optimization**

### **Database**
- Monitor query performance
- Add indexes for frequently queried fields
- Use connection pooling

### **File Storage**
- Use CDN for file delivery
- Implement file compression
- Set appropriate cache headers

### **API Performance**
- Monitor response times
- Implement caching where appropriate
- Use rate limiting

## ðŸ”„ **Backup & Recovery**

### **Database Backups**
- Set up automated daily backups
- Test backup restoration process
- Store backups in multiple locations

### **File Backups**
- Enable S3 versioning
- Set up cross-region replication
- Regular backup testing

### **Configuration Backups**
- Document all configuration changes
- Version control configuration files
- Regular configuration audits

## ðŸ“ž **Support Contacts**

- **SendGrid Support**: [support.sendgrid.com](https://support.sendgrid.com)
- **Stripe Support**: [support.stripe.com](https://support.stripe.com)
- **Lob Support**: [support.lob.com](https://support.lob.com)
- **AWS Support**: [aws.amazon.com/support](https://aws.amazon.com/support)
- **Sentry Support**: [sentry.io/support](https://sentry.io/support)

---

**Last Updated**: January 2024
**Version**: 1.0.0
